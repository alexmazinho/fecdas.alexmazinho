{# src/Fecdas/PartesBundle/Resources/views/Page/index.html.twig #}
{% extends 'FecdasBundle::layout.html.twig' %}

{% block stylesheets %}
	
	<link href="{{ asset('css/jquery.datetimepicker.css') }}" type="text/css" rel="stylesheet" />
	
	{{ parent() }}
{% endblock %}

{% block title %}Aplicació gestió FECDAS. Relació d'assegurats del Club{% endblock %}

{% block body %}
   	{{ form_start(form, {'action': path('FecdasBundle_assegurats'), 'method': 'POST', 'attr': {'class': 'appform', 'id':'form_assegurats'}}) }}
		<header>
			<div class="row">
				<div class="col-md-8"><h1>Relació d'assegurats</h1></div>
    		    <div class="col-md-4 col-last-right">
					{% if persones.getTotalItemCount <= 3000 %}
						<div class="buttons-top-bootstrap">
							<div class="button-top"><a class="link" href="{{ path('FecdasBundle_asseguratstopdf', persones.params) }}" alt="Descarregar les llistes" 
								title="Descarregar les llistes">
								<i class="fa fa-file-pdf-o fa-1x red"></i></a></div> 
							<div class="button-top"><a class="print link" target="_blank" href="{{ path('FecdasBundle_asseguratstopdf', persones.params|merge({ 'print': 1 })) }}" alt="Imprimir les llistes" 
								title="Imprimir les llistes">
								<i class="fa fa-print fa-1x blue"></i></a></div>
							<div class="button-top"><a class="link export-csv" href="{{ path('FecdasBundle_assegurats', persones.params|merge({ 'format': 'csv' })) }}" alt="Exportar dades" 
								title="Exportar dades"><i class="fa fa-file-excel-o fa-1x green"></i></a></div>	
						</div> 
					{% endif %}
				</div>
			</div>
   		</header>
   		<div class="row">
			{% if admin == true %}
				<div class="col-md-12">
					<div class="checkbox">
				    	<label>
				      		{{ form_widget(form.tots) }} (Admins.) Qualsevol club
				    	</label>
					</div>
				</div>
			{% endif %}
			<div class="col-md-2 col-xs-4">
				<div class="form-group">
					{{ form_label(form.desde, 'Altes des de') }}
					<div class="input-group" >
						{{ form_widget(form.desde, { 'attr': {'class': 'form-control formtime-calendar'} }) }}
						<span class="input-group-addon input-group-addon-icon open-calendar"><span class="fa fa-calendar fa-1x"></span></span>
					</div>
				</div>
			</div>
	    	<div class="col-md-2 col-xs-4">
				<div class="form-group">
					{{ form_label(form.fins, 'fins') }}
					<div class="input-group" >
						{{ form_widget(form.fins, { 'attr': {'class': 'form-control formtime-calendar'} }) }}
						<span class="input-group-addon input-group-addon-icon open-calendar"><span class="fa fa-calendar fa-1x"></span></span>
					</div>
				</div>
			</div>
			<div class="col-md-5 col-xs-4">
				<label>&nbsp;</label>
				<div class="checkbox">
			    	<label>
			      		{{ form_widget(form.vigent) }} Només mostrar les llicències vigents
			    	</label>
				</div>
			</div>
		</div>
   		<div class="row">
			<div class="col-md-2 col-xs-4">
			  	<div class="form-group">
			  		<div class="input-group">
				    	{{ form_label(form.dni, 'DNI/NIE', { 'label_attr': {'class': 'sr-only'} }) }}
						{{ form_widget(form.dni, { 'attr': {'class': 'form-control','placeholder':'DNI/NIE' } }) }}
						<span class="input-group-addon input-group-addon-icon"><span class="fa fa-search fa-1x"></span></span>
					</div>
				</div>
			</div>
			<div class="col-md-4 col-xs-4">
			  	<div class="form-group">
			  		<div class="input-group">
				    	{{ form_label(form.nom, 'Nom', { 'label_attr': {'class': 'sr-only'} }) }}
						{{ form_widget(form.nom, { 'attr': {'class': 'form-control', 'placeholder':'Nom' } }) }}
						<span class="input-group-addon input-group-addon-icon"><span class="fa fa-search fa-1x"></span></span>
					</div>
				</div>
			</div>
			<div class="col-md-4  col-xs-4">
			  	<div class="form-group">
			  		<div class="input-group">
				    	{{ form_label(form.cognoms, 'Cognoms', { 'label_attr': {'class': 'sr-only'} }) }}
						{{ form_widget(form.cognoms, { 'attr': {'class': 'form-control', 'placeholder':'Cognoms' } }) }}
						<span class="input-group-addon input-group-addon-icon"><span class="fa fa-search fa-1x"></span></span>
					</div>
				</div>
			</div>
			<div class="col-md-2 col-xs-12 col-last-right">
				<button id="formassegurats-submit"  type="submit" class="btn btn-default"><i class="fa fa-search blue"></i> cerca</button>
			</div>
		</div>
		<div class="row"><div class="col-md-12 block-errors">{% include 'FecdasBundle:Includes:messages.html.twig' %}</div></div>
    {{ form_end(form) }}

	<div id="llista-assegurats" class="llista-dadespersonals">
		<div class="table-header">	
		   	<div id="list-header">
		   		<div id="header-asseguratid" class="col-listheader">id</div>
		   		<div id="header-asseguratcompacte" class="col-listheader col-responsive">Assegurat<span class="listheader-order"></span></div>
		   		<div id="header-asseguratdni" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'DNI', 'e.dni') }}
		   				<span class="listheader-icon {% if persones.isSorted('e.dni') %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-asseguratnom" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'Nom', 'e.nom') }}
		   				<span class="listheader-icon {% if persones.isSorted('e.nom') %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-asseguratcognoms" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'Cognoms', 'e.cognoms', {'direction': 'desc'}) }}
		   				<span class="listheader-icon {% if sortparams['direction'] == '' %} listheader-icon-asc {% endif %}{% if sortparams['sort'] == 'e.cognoms' %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-asseguratnaixement" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'Nascut/da', 'e.datanaixement') }}
		   				<span class="listheader-icon {% if persones.isSorted('e.nom') %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-assegurattipusdesc" class="col-listheader listheader-noorder">Llicències</div>
		   		<div id="header-asseguratactions" class="col-listheader listheader-noorder total-rowcount">Total: {{ persones.getTotalItemCount|number_format(0, ',', '.') }}</div>
		   	</div>
	   	</div>
		{% if persones|length > 0 %}
		<div class="table-scroll">
		   	<ol id="list-data">
			{% for persona in persones %}
			   		<li class="data-detall">
				   		<div class="data-detall-cell assegurat-id">{{ persona.id }}</div>
				   		<div class="data-detall-cell assegurat-compacte col-responsive">{{ persona.cognoms }}, {{ persona.nom }} ({{ persona.dni }})</div>
				   		<div class="data-detall-cell assegurat-dni col-noresponsive">{{ persona.dni }}</div>
				   		<div class="data-detall-cell assegurat-nom col-noresponsive">{{ persona.nom }}</div>
				   		<div class="data-detall-cell assegurat-cognoms col-noresponsive">{{ persona.cognoms }}</div>
				   		<div class="data-detall-cell assegurat-naixement col-noresponsive">{% if persona.datanaixement is not null %} {{ persona.datanaixement|date('d/m/Y') }}{% endif %}</div>
				   		<div class="data-detall-cell assegurat-tipusdesc">
				   			<a class="link-historial llicencies-historial" href="{{ path('FecdasBundle_historialllicencies', { 'id': persona.id }) }}"  alt="Historial llicències" title="Historial llicències">
				   			<i class="fa fa-history orange"></i><span>{{ persona.getInfoHistorialLlicencies(admin, persones.params.desde, persones.params.fins) }}</span>
			   				</a>
						</div>
				   		{% if persona.llicenciaVigent is not null and persona.llicenciaVigent.parte is not null %}
							<div class="data-detall-cell assegurat-actions">
								{% if persona.llicenciaVigent.parte.allowPrintLlicencia == true %}
									<a class="llicencia-imprimir link" href="{{ path('FecdasBundle_licensetopdf', { 'id': persona.llicenciaVigent.id}) }}" alt="Imprimir llicència" title="Imprimir llicència">
										<i class="fa fa-list-alt fa-1x orange"></i></a>
								{% endif %}
								{% if admin == true %}
									<a class="llicencia-duplicat link" href="{{ path('FecdasBundle_duplicatllicencia', { 'id': persona.llicenciaVigent.id}) }}" 
										data-club="{{ persona.llicenciaVigent.parte.clubparte.nom }}"
										data-persona="{{ persona.nomcognoms }}" alt="Duplicat llicència" title="Duplicat llicència">
										<i class="fa fa-copy fa-1x lightblue"></i></a>
								{% endif  %}
								{% if persona.llicenciaVigent.parte.allowRenovar %}
									<a class="llicencia-renovar link" href="{{ path('FecdasBundle_renovarllicencia', { 'id': persona.llicenciaVigent.id }) }}" alt="Renovar llicència" title="Renovar llicència">
					   					<i class="fa fa-retweet fa-1x green"></i></a>
				   				{% endif %}
				   				<a class="parte-action-view link" href="{{ path('FecdasBundle_parte', { 'id': persona.llicenciaVigent.parte.id, 'action':'view' }) }}"  alt="Veure llicència" title="Veure llicència">
				   					<i class="fa fa-search fa-1x blue"></i></a>
								<a class="formpersona-openmodal link" href="{{ path('FecdasBundle_persona', { 'id': persona.id }) }}" name="modal" alt="Editar dades federat" title="Editar dades federat">
				   					<i class="fa fa-user fa-1x red"></i></a>
			   				</div>
			   			{% else %}
			   				{% if persona.lastLlicencia is not null and persona.lastLlicencia.parte is not null %}
				   				<div class="data-detall-cell assegurat-actions">
			   					<a class="llicencia-renovar link" href="{{ path('FecdasBundle_renovarllicencia', { 'id': persona.lastLlicencia.id }) }}" alt="Renovar llicència" title="Renovar llicència">
			   						<i class="fa fa-retweet fa-1x green"></i></a>
			   					<a class="parte-action-view link" href="{{ path('FecdasBundle_parte', { 'id': persona.lastLlicencia.parte.id, 'action':'view' }) }}" alt="Veure llicència" title="Veure llicència">
			   						<i class="fa fa-search fa-1x blue"></i></a>
				   				<a class="formpersona-openmodal link" href="{{ path('FecdasBundle_persona', { 'id': persona.id }) }}" name="modal"  alt="Editar dades federat" title="Editar dades federat">
			   						<i class="fa fa-user fa-1x red"></i></a>
			   					</div>
			   				{% else %}
			   					<div class="data-detall-cell assegurat-actions">
			   					<a class="formpersona-openmodal link" href="{{ path('FecdasBundle_persona', { 'id': persona.id }) }}" name="modal"  alt="Editar dades federat" title="Editar dades federat">
			   						<i class="fa fa-user fa-1x red"></i></a>
			   					</div>
			   				{% endif %}	
				   		{% endif %}		
			   		</li>
			{% endfor %}
			</ol>
		</div>
		{% if persones.getTotalItemCount > 10 %}<div class="navigation">Pàgines: {{ knp_pagination_render(persones, null, sortparams) }}</div>{% endif %}		
	   	{% else %}
	   		
	        <div class="sms-notice">Cerca sense resultats</div>
	    {% endif %}
	</div>
    
    <div id="historial-llicencies" class="finestra-overlay"></div>
    <div id="edicio-persona" class="finestra-overlay"></div>
    
{% endblock %}

{% block javascripts %}

{{ parent() }}

	<!-- Datetime plugin's. http://xdsoft.net/jqplugins/datetimepicker/ -->
	<script src="{{ asset('js/jquery.datetimepicker.js') }}" type="text/javascript"></script>

	<script src="{{ asset('js/utils/purl.js') }}" type="text/javascript"></script>
	
	<script type="text/javascript">
	
	$(document).ready(function(){
		setMenuActive("menu-assegurats");
		
		helpBubbles("#form_dni", '<p>Indica tot o part del <b>DNI/NIE</b> a cercar</p>');
		
		helpBubbles("#form_nom", '<p>Indica tot o part del <b>NOM</b> a cercar</p>\
		<p>La cerca no distingeix majúscules o minúscules</p>');
	
		helpBubbles("#form_cognoms", '<p>Indica tot o part dels <b>COGNOMS</b> a cercar</p>\
		<p>La cerca no distingeix majúscules o minúscules</p>');
	
		//select all the a tag with name equal to modal
		$('.formpersona-openmodal')
	    .off('click')
	    .click(function(e) {
			//Cancel the link behavior
	        e.preventDefault();
	        
	        var url = $(this).attr("href");
	        showPersonModal(url, 'assegurats', function () {
		        // Reload 
	        	$('#form_assegurats').submit();
	        });
	    });

		
		showHistorialLlicencies();

		$(window).resize(function() {
			hideMask();
	        
	        if ($.browser.msie) $('.assegurat-historial').hide(); 
	    	else $('.assegurat-historial').slideUp('slow');
		});
		
		$('#form_assegurats').submit(function () {
			// Recarrega consulta afegint la dades del formulari
			asseguratsReload("{{ path('FecdasBundle_assegurats', sortparams)|raw }}");
			return false;
		});

		var current = new Date();
		var mindate = new Date (current.getFullYear()-5, current.getMonth(), current.getDay());
		var maxdate = new Date (current.getFullYear()+1, current.getMonth(), current.getDay());
		initDateTimePicker ( 
			$( '#form_desde' ), 
			mindate, 
			maxdate, 
			current, 
			'desde-picker', 
			false,
			function (selectedDateTime) {
				//asseguratsReload("{# path('FecdasBundle_assegurats', sortparams)|raw #}");  
			}
		);
	
		initDateTimePicker ( 
			$( '#form_fins' ), 
			mindate, 
			maxdate, 
			current, 
			'fins-picker', 
			false,
			function (selectedDateTime) {
				//asseguratsReload("{# path('FecdasBundle_assegurats', sortparams)|raw #}"); 
			}
		);
		
		$('#form_tots').change(function () {
			// Recarrega consulta afegint la dades del formulari
			//asseguratsReload("{# path('FecdasBundle_assegurats', sortparams)|raw #}");
			
		});
	
		$('#form_vigent').change(function () {
			// Recarrega consulta afegint la dades del formulari
			if ( $('#form_vigent').is(':checked') ) {
				$( '#form_desde, #form_fins' ).prop('disabled', 'disabled').val( '' );
				//$( '#form_desde, #form_fins' ).prop('placeholder', '--');
			} else {
				// Posar dates any en curs
				$( '#form_desde, #form_fins' ).removeAttr('disabled');
				$( '#form_desde' ).val( '01/01/'+current.getFullYear() );	
				$( '#form_fins' ).val( '31/12/'+current.getFullYear() );
				//asseguratsReload("{# path('FecdasBundle_assegurats', sortparams)|raw #}");
			}
			
		});

		$( ".llicencia-duplicat" ).click(function (e) {
			e.preventDefault();
			
			var url = $(this).attr('href');

			var club = $(this).attr('data-club'); 

			var persona = $(this).attr('data-persona');
			
			var strHtml = "<p>Duplicat llicència "+persona+"</p>";
			strHtml += "   <div class='form-group'>";
			strHtml += "	  <div class='checkbox'>";
			strHtml += "		<label>";
			strHtml += "			<input type='checkbox' value='0' id='checkfactura'>"; 
			strHtml += "			Cal crear una comanda nova per aquest duplicat a càrrec del club "+club+"?";
			strHtml += "		</label>";
			strHtml += "	  </div>";
			strHtml += "      <div id='formduplicat-datafactura' style='display:none'>";
			strHtml += "      	<label for='comanda_datafactura'>Data facturació</label>";
			strHtml += "	    <input type='text' id='datafacturacio' disabled='disabled'/>";
			strHtml += "      </div>";
			strHtml += "  </div>";

			dialegConfirmacio(strHtml, 'Comanda duplicat', 'auto', 400, function() { 
				
				url += '&factura='+($('#checkfactura').is(':checked')?1:0)+'&datafacturacio='+$('#datafacturacio').val();
					
				window.location = url;
				 
			}, function() { closeDialegConfirmacio(); }, function() {

				$("#checkfactura").click(function(){
					var checked = $(this).is(':checked');
					if (checked) {
						$( "#datafacturacio" ).datepicker({
				      		showOn: "button",
				            //buttonImage: "/images/icon-calendar.gif",
				            buttonText: "<i class='fa fa-calendar fa-1x blue'></i>",
				            //buttonImageOnly: true,
				            dateFormat: 'dd/mm/yy'
				      	});
					    
					  	$( "#datafacturacio" ).datepicker( "setDate", new Date() );

					  	$( "#formduplicat-datafactura").show();
					} else {
						$( "#formduplicat-datafactura").hide();

						$( "#datafacturacio" ).datepicker('destroy');
					}
				});
				
	        	
			});
		});
		
		
		var tableScroll = $('.table-scroll');
		if (tableScroll.hasOverflowY()) {
			$('.table-scroll').css({"width":"101.5%"});
		}
	});
	
	</script>


{% endblock %}
