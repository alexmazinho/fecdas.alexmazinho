{# src/Fecdas/PartesBundle/Resources/views/Page/index.html.twig #}
{% extends 'FecdasPartesBundle::layout.html.twig' %}

{% block javascriptshead %}
 	{{ parent() }}
 	<script src="{{ asset('js/utils/purl.js') }}" type="text/javascript"></script>
   	{{ form_javascript(form) }}
{% endblock %}

{% block title %}Aplicació gestió FECDAS. Relació d'assegurats del Club{% endblock %}

{% block body %}
	<header>
        <h1>Relació d'assegurats</h1>
    </header>

   	<form id="form_assegurats" action="{{ path('FecdasPartesBundle_assegurats') }}" method="post" {{ form_enctype(form) }}  class="appform">
   		<div class="form-row">
   			<div id="formassegurats-tots" class="form-left">
				{{ form_label(form.tots, '(Admins.) Qualsevol club', { 'label_attr': {'class': 'formlabel-lefttocheckbox'} }) }}
				{{ form_widget(form.tots, { 'attr': {'class': 'formcheckbox-right'} }) }}
			</div>
			<div id="formassegurats-vigent" class="form-left">
				{{ form_label(form.vigent, 'Només mostrar les llicències vigents', { 'label_attr': {'class': 'formlabel-lefttocheckbox'} }) }}
				{{ form_widget(form.vigent, { 'attr': {'class': 'formcheckbox-right'} }) }}
			</div>
			<div class="buttons-top">
				<div class="button-top"><a href="{{ path('FecdasPartesBundle_asseguratstopdf', persones.params) }}">
					<img src="{{ asset('images/icon-pdf.png') }}" alt="Descarregar les llistes" 
					title="Descarregar les llistes" width="40px"></a></div> 
				<div class="button-top"><a class="print-link" target="_blank" href="{{ path('FecdasPartesBundle_asseguratstopdf', persones.params|merge({ 'print': 1 })) }}">
					<img src="{{ asset('images/icon-print.png') }}" alt="Descarregar les llistes" 
					title="Descarregar les llistes" width="40px"></a></div>
			</div> 
		</div>
   		<div class="form-row clearfix">
   			{{ form_widget(form.page) }}
   			{{ form_widget(form.sort) }}
   			{{ form_widget(form.direction) }}
			<div id="formassegurats-dni" class="form-left">
				{{ form_label(form.dni, 'DNI/NIE', { 'label_attr': {'class': 'formlabel-inside'} }) }}
				{{ form_widget(form.dni, { 'attr': {'class': 'forminput-inside'} }) }}
			</div> 
   			<div id="formassegurats-nom" class="form-left">
				{{ form_label(form.nom, 'Nom', { 'label_attr': {'class': 'formlabel-inside'} }) }}
				{{ form_widget(form.nom, { 'attr': {'class': 'forminput-inside'} }) }}
			</div> 
        	<div id="formassegurats-cognoms" class="form-left">
				{{ form_label(form.cognoms, 'Cognoms', { 'label_attr': {'class': 'formlabel-inside'} }) }}
				{{ form_widget(form.cognoms, { 'attr': {'class': 'forminput-inside'} }) }}
			</div> 
			<div id="formassegurats-submit" class="form-right">	
				<input type="submit" class="forminput-inside" value="Cerca" name="formassegurats-button-search"/>
			</div> 
   		</div>
    </form>

    {% for flashMessage in app.session.flashbag.get('error-notice') %}
    <div class="sms-notice">
		{{ flashMessage }}
  	</div>	
	{% endfor %}
	<div id="llista-assegurats">
		<div class="table-header">	
		   	<div id="list-header">
		   		<div id="header-asseguratid" class="col-listheader">id</div>
		   		<div id="header-asseguratcompacte" class="col-listheader col-responsive">Assegurat<span class="listheader-order"></span></div>
		   		<div id="header-asseguratdni" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'DNI', 'e.dni') }}
		   				<span class="listheader-icon {% if persones.isSorted('e.dni') %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-asseguratnom" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'Nom', 'e.nom') }}
		   				<span class="listheader-icon {% if persones.isSorted('e.nom') %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-asseguratcognoms" class="col-listheader col-noresponsive col-listheader-sortable">{{ knp_pagination_sortable(persones, 'Cognoms', 'e.cognoms', {'direction': 'desc'}) }}
		   				<span class="listheader-icon {% if sortparams['direction'] == '' %} listheader-icon-asc {% endif %}{% if sortparams['sort'] == 'e.cognoms' %} listheader-icon-{{ sortparams['direction'] }} {% endif %}"></span></div>
		   		<div id="header-assegurattipusdesc" class="col-listheader listheader-noorder">Llicències</div>
		   		<div id="header-asseguratactions" class="col-listheader listheader-noorder total-rowcount">Total: {{ persones.getTotalItemCount|number_format(0, ',', '.') }}</div>
		   	</div>
	   	</div>
		{% if persones|length > 0 %}
		<div class="table-scroll">
		   	<ol id="list-data">
			{% for persona in persones %}
			   		<li class="data-detall">
				   		<div class="data-detall-cell assegurat-id">{{ persona.id }}</div>
				   		<div class="data-detall-cell assegurat-compacte col-responsive">{{ persona.cognoms }}, {{ persona.nom }} ({{ persona.dni }})</div>
				   		<div class="data-detall-cell assegurat-dni col-noresponsive">{{ persona.dni }}</div>
				   		<div class="data-detall-cell assegurat-nom col-noresponsive">{{ persona.nom }}</div>
				   		<div class="data-detall-cell assegurat-cognoms col-noresponsive">{{ persona.cognoms }}</div>
				   		<div class="data-detall-cell assegurat-tipusdesc">
				   			<a class="llicencia-historial" href="{{ path('FecdasPartesBundle_historialLlicencies', { 'id': persona.id }) }}" title="Historial llicències">
				   			<img src="{{ asset('images/icon-historial.png') }}" alt="Historial llicències" title="Historial llicències" width="23px">
				   			<span>{{ persona.getInfoAssegurats(admin) }}</span>
			   				</a>
						</div>
				   		{% if persona.llicenciaVigent is not null and persona.llicenciaVigent.parte is not null %}
							<div class="data-detall-cell assegurat-actions">
							{% if persona.llicenciaVigent.parte.allowPrintLlicencia == true %}
							<a class="action-cell llicencia-imprimir" href="{{ path('FecdasPartesBundle_licensetopdf', { 'id': persona.llicenciaVigent.id}) }}">
								<img src="{{ asset('images/icon-license.png') }}" alt="Imprimir llicència" title="Imprimir llicència" width="23px"></a>
							{% else %}
							<div class="action-cell"></div>
							{% endif %}
							{% if persona.llicenciaVigent.parte.allowRenovar %}
							<a class="action-cell llicencia-renovar" href="{{ path('FecdasPartesBundle_renovarllicencia', { 'id': persona.llicenciaVigent.id }) }}">
			   					<img src="{{ asset('images/icon-renovar.png') }}" alt="Renovar llicència" title="Renovar llicència" width="23px"></a>
			   				{% endif %}
			   				<a class="action-cell parte-action-view" href="{{ path('FecdasPartesBundle_parte', { 'id': persona.llicenciaVigent.parte.id, 'action':'view' }) }}">
			   					<img src="{{ asset('images/icon-view.png') }}" alt="Veure llicència" title="Veure llicència" width="23px"></a>
							<a class="action-cell assegurats-openmodal" href="{{ path('FecdasPartesBundle_persona') }}" name="modal">
			   					<img src="{{ asset('images/icon-edit-user.png') }}" alt="Editar dades federat" title="Editar dades federat" width="23px"></a>
			   				</div>
			   			{% else %}
			   			
			   				{% if persona.lastLlicencia is not null and persona.lastLlicencia.parte is not null %}
				   				<div class="data-detall-cell assegurat-actions">
			   					<a class="llicencia-renovar" href="{{ path('FecdasPartesBundle_renovarllicencia', { 'id': persona.lastLlicencia.id }) }}">
			   						<img src="{{ asset('images/icon-renovar.png') }}" alt="Renovar llicència" title="Renovar llicència" width="23px"></a>
			   					<a class="parte-action-view" href="{{ path('FecdasPartesBundle_parte', { 'id': persona.lastLlicencia.parte.id, 'action':'view' }) }}">
			   						<img src="{{ asset('images/icon-view.png') }}" alt="Veure llicència" title="Veure llicència" width="23px"></a>
				   				<a class="assegurats-openmodal" href="{{ path('FecdasPartesBundle_persona') }}" name="modal">
			   						<img src="{{ asset('images/icon-edit-user.png') }}" alt="Editar dades federat" title="Editar dades federat" width="23px"></a>
			   					</div>
			   				{% else %}
			   					<div class="data-detall-cell assegurat-actions">
			   					<a class="assegurats-openmodal" href="{{ path('FecdasPartesBundle_persona') }}" name="modal">
			   						<img src="{{ asset('images/icon-edit-user.png') }}" alt="Editar dades federat" title="Editar dades federat" width="23px"></a>
			   					</div>
			   				{% endif %}	
				   		{% endif %}		
			   		</li>
			{% endfor %}
			</ol>
		</div>
		{% if persones.getTotalItemCount > 10 %}<div class="navigation">Pàgines: {{ knp_pagination_render(persones, null, sortparams) }}</div>{% endif %}		
	   	{% else %}
	   		
	        <div class="sms-notice">Cerca sense resultats</div>
	    {% endif %}
	</div>
    
    <div id="historial-llicencies" class="finestra-overlay"></div>
    <div id="edicio-persona" class="finestra-overlay"></div>
    
{% endblock %}

{% block javascripts %}

{{ parent() }}

<script type="text/javascript">

$(document).ready(function(){
	setMenuActive("menu-assegurats");
	
	helpBubbles("#form_dni", '<p>Indica tot o part del <b>DNI/NIE</b> a cercar</p>');
	
	helpBubbles("#form_nom", '<p>Indica tot o part del <b>NOM</b> a cercar</p>\
	<p>La cerca no distingeix majúscules o minúscules</p>');

	helpBubbles("#form_cognoms", '<p>Indica tot o part dels <b>COGNOMS</b> a cercar</p>\
	<p>La cerca no distingeix majúscules o minúscules</p>');

	showPersonClickAssegurats();

	showHistorialLlicencies();

	//sortLlista("col-listheader", "list-data");
	//llistaPaginationAndSort($('#form_assegurats'));

	var tableScroll = $('.table-scroll');
	if (tableScroll.hasOverflowY()) {
		$('.table-scroll').css({"width":"101.5%"});
	}
});

</script>


{% endblock %}
