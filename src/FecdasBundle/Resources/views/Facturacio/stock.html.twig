{# src/Fecdas/productesBundle/Resources/views/Facturacio/stock.html.twig #}
{% extends 'FecdasBundle::layout.html.twig' %}

{% block stylesheets %}
	<!-- Select2 styles -->
	<link href="{{ asset('css/select2.css') }}" type="text/css" rel="stylesheet" />
	<link href="{{ asset('css/jquery.datetimepicker.css') }}" type="text/css" rel="stylesheet" />
	
	{{ parent() }}
{% endblock %}

{% block javascriptshead %}
 	
{% endblock %}

{% block title %}Aplicació gestió FECDAS. Registre d'inventari {% endblock %}

{% block body %}
	<header>
        <div class="row">
			<div class="col-md-8"><h1>Registre d'inventari</h1></div>
		    <div class="col-md-4 col-last-right">
				<div class="buttons-top-bootstrap">
					<div class="button-top"><a class="link export-csv" href="{{ path('FecdasBundle_stock', { 'format': 'csv' }) }}" alt="Exportar dades" 
						title="Exportar dades"><i class="fa fa-file-excel-o fa-1x green"></i></a></div>	
				</div> 
			</div>
		</div>
    </header>
	{% include 'FecdasBundle:Includes:messages.html.twig' %}
        
    <div id="stock-main">
	    <div id="list-forms">
	    	<div class="row">
				<div class="col-md-4">
					<div class="form-group">
				    	{{ form_label(form.cerca, 'Cercar', { 'label_attr': {'class': 'sr-only'} }) }}
						{{ form_widget(form.cerca, { 'attr': {'class': 'form-control'} }) }}
					</div>
				</div>
				<div class="col-md-8 col-last-right">
					<a type="submit" class="btn btn-default btn-lg registrestock-action-new" href="{{ path('FecdasBundle_registrestock', { 'action': 'new', 'id': 0 }) }}" alt="Nou registre" title="Nou registre"><i class="fa fa-plus-circle"></i> afegir</a>
				</div>
			</div>
	    </div>
	    <div class="table-header">	
		   	<div id="list-header">
				<div id="header-registrestock-id" class="col-listheader hidden">&nbsp;</div>
				<div id="header-registrestock-dataregistre" class="col-listheader collistheader-noorder">Data</div>
				<div id="header-registrestock-comentaris" class="col-listheader collistheader-noorder">Comentaris</div>
				<div id="header-registrestock-factura" class="col-listheader collistheader-noorder">Factura</div>
				<div id="header-registrestock-producte" class="col-listheader collistheader-noorder">Producte</div>
		   		<div id="header-registrestock-entrada" class="col-listheader collistheader-noorder">Entrada</div>
		   		<div id="header-registrestock-sortida" class="col-listheader collistheader-noorder">Sortida</div>
		   		<div id="header-registrestock-preuunitat" class="col-listheader collistheader-noorder">Preu ud.</div>
		   		<div id="header-registrestock-total" class="col-listheader collistheader-noorder">Preu ud.</div>
		   		<div id="header-registrestock-stock" class="col-listheader collistheader-noorder">Stock</div>
		   		<div id="header-registrestock-actions" class="col-listheader collistheader-noorder total-rowcount">Total: {{ stock.getTotalItemCount|number_format(0, ',', '.') }}</div>
		   	</div>
	   	</div>
		{% if stock|length > 0 %}
		<div class="table-scroll">
		   	<ol id="list-data">
			{% for registre in stock %} 
		   		<li class="data-detall {% if registre.anulat %} data-detall-fosc {% endif %}">
		   			<div class="data-detall-cell registrestock-id hidden">{{ registre.id }}</div>
		   			<div class="data-detall-cell registrestock-dataregistre">{{ registre.dataregistre|date('d/m/Y') }}</div>
		   			<div class="data-detall-cell registrestock-comentaris">{{ registre.comentaris }}</div>
		   			<div class="data-detall-cell registrestock-factura">{% if registre.factura != null %}{{ registre.factura.numfactura }} {% endif %}</div>
		   			<div class="data-detall-cell registrestock-producte">{{ registre.producte.descripcio }}</div>
		   			<div class="data-detall-cell registrestock-entrada">{% if (registre.tipus == constant('FecdasBundle\\Controller\\BaseController::REGISTRE_STOCK_ENTRADA')) %} {{ registre.unitats }}  {% endif %}</div>
		   			<div class="data-detall-cell registrestock-sortida">{% if (registre.tipus == constant('FecdasBundle\\Controller\\BaseController::REGISTRE_STOCK_SORTIDA')) %} {{ registre.unitats }}  {% endif %}</div>
		   			<div class="data-detall-cell registrestock-preuunitat">{{ registre.preuunitat|number_format(2, ',', '.') }}€</div>
		   			<div class="data-detall-cell registrestock-total">{{ (registre.preuunitat*registre.unitats)|number_format(2, ',', '.') }}€</div>
		   			<div class="data-detall-cell registrestock-stock">{{ registre.stock }}</div>
		   			<div class="data-detall-cell registrestock-actions">
		   				<a class="registrestock-action-edit link" href="{{ path('FecdasBundle_registrestock', { 'action': 'edit', 'id': registre.id }) }}" alt="Editar" title="Editar"><i class="fa fa-pencil blue"></i></a>			
						{% if not registre.anulat %}
		   				<a class="registrestock-action-baixa link" href="{{ path('FecdasBundle_registrestock', { 'action': 'remove', 'id': registre.id }) }}" alt="Baixa" title="Baixa"><i class="fa fa-trash-o red"></i></a>
		   				{% else %}
		   				<i class="fa fa-trash-o transparent"></i>
		   				{% endif %}
		   			</div>
		   		</li>
		   		{% endfor %}
			</ol>
		</div>
		{% if stock.getTotalItemCount > 10 %}<div class="navigation">Pàgines: {{ knp_pagination_render(stock, null, [] ) }}</div>{% endif %}
	   	{% else %}
	    <div class="sms-notice">No hi ha stock per mostrar</div>
	    {% endif %}
	</div>
    <div id="dialeg-edicio-producte" class="finestra-overlay"></div>
{% endblock %}

{% block javascripts %}

	{{ parent() }}
	<!-- Datetime plugin's. http://xdsoft.net/jqplugins/datetimepicker/ -->
	<script src="{{ asset('js/jquery.datetimepicker.js') }}" type="text/javascript"></script>
	<script src="{{ asset('js/jquery.ui.datepicker-ca.js') }}" type="text/javascript"></script>
	
	<script type="text/javascript">
	
	$(document).ready(function(){
		setMenuActive("menu-admproductes");

		$("#form_cerca").change(function() {

			var url = "{{ path('FecdasBundle_stock', { 'action': 'list' }) }}";

			if ($(this).val() != '') {
				url += "&cerca="+$(this).val();
			}
			
			window.location = url;
	    });
	
		$('.registrestock-action-new, .registrestock-action-edit').click( function(e) {
			e.preventDefault();
			
			var url = $(this).attr("href");

			$('.alert').remove();
			
			showMask();
			
			$.get(url, function(data) {

				$( '#dialeg' ).html(data);
				
				$( '#dialeg' ).dialog({
					 resizable: false,
					 title: "Registre stock",
					 height: "auto",
					 width:  600,
					 modal: false, /* Important sinó tabindex=-1 dona error amb els selec2 */
					 buttons: {
					 	"Desar": function() {

							var url = $('#formregistrestock').attr("action");
					 		var params = $('#formregistrestock').serializeArray();

					 		$('#progressbar').show();  // Rellotge

					 		$('#formregistrestock .alert').remove();
					 		
							$.post(url, params, function(data, textStatus) {
								$('#progressbar').hide();  // Rellotge

								hideMask();

								var sms = smsResultAjax('OK', data);
								
								$("#stock-main").prepend(sms);

						 		$( '#dialeg' ).html('');
						 		$( '#dialeg' ).dialog( "close" );
						 		
							}).fail( function(xhr, status, error) {
								 var sms = smsResultAjax('KO', xhr.responseText);
								 
								 $('#progressbar').hide();  // Rellotge
							    	
							     $("#formregistrestock").prepend(sms);
							});
					 	},
					 	"Cancel·lar": function() {

					 		hideMask();					 		
	
					 		$( '#dialeg' ).html('');
					 		$( '#dialeg' ).dialog( "close" );
					 	}
					 },
					 close: function() {
						 hideMask();
						 $( '#dialeg' ).html('');
					 	 $( '#dialeg' ).dialog( "close" );
					 },	 
					 open: function() {

						// Select factura
						init_cercagenerica_JSON('#registrestock_factura', 'Cercar factura', "{{ path('FecdasBundle_jsonfactures') }}");
						 
						$("select#registrestock_producte").select2({
							minimumInputLength: 2,
							allowClear: true,
							placeholder: 'Escollir producte'
						});

						var current = new Date();
						var mindate = new Date (current.getFullYear() - 2, current.getMonth(), current.getDay());
						var maxdate = new Date (current.getFullYear(), current.getMonth()+2, current.getDay());
								
						initDateTimePicker ( 
							$( '#registrestock_dataregistre' ), 
							mindate, 
							maxdate,
							current, 
							'dataregistre-picker', 
							false,
							function() {} 
						);

						if ($( '#registrestock_databaixa' ).val() != '') {
							initDateTimePicker ( 
								$( '#registrestock_databaixa' ), 
								mindate, 
								maxdate,
								current, 
								'databaixa-picker', 
								false,
								function() {} 
							);
						}
					
					 }
				});

			}).fail( function(xhr, status, error) {
				 // xhr.status + " " + xhr.statusText, status, error
				 hideMask();
				 
				 var sms = smsResultAjax('KO', xhr.responseText);
	 			 
				 $("#stock-main").prepend(sms);
			});	
		});
		

		$('.registrestock-action-baixa').click( function(e) {
			e.preventDefault();

			$('.alert').remove();

			var row = $(this).parents('.data-detall');
			
			var url = $(this).attr('href');
			
			var strHtml = '<p>Segur que vols anul·lar el registre?</p>';

			dialegConfirmacio(strHtml, 'Baixa registre', 'auto', 400, function() { 

				showMask();
				
				$.get(url, function(data) {
					hideMask();

					row.remove();
					
					var sms = smsResultAjax('OK', data);
		 			 
					$("#stock-main").prepend(sms);

				}).fail( function(xhr, status, error) {
					 // xhr.status + " " + xhr.statusText, status, error
					 hideMask();
					 
					 var sms = smsResultAjax('KO', xhr.responseText);
		 			 
					 $("#stock-main").prepend(sms);
				});	
				 
			}, function() { }, function() { });
		});

		
		$("a.export-csv").change(function(e) {
			e.preventDefault();

			var url = $( this ).attr('href');

			if ($("#form_cerca").val() != '') {
				url += "&cerca="+$("#form_cerca").val();
			}

			window.location = url;
		});

		// Descripcio producte
		init_cercaproducte_JSON('#form_cerca', 'descripcio', 'Cercar descripció del producte', "{{  path('FecdasBundle_jsonproductes') }}", 0);
	});
	
	</script>


{% endblock %}

