{# src/Fecdas/PartesBundle/Resources/views/Page/index.html.twig #}
{% extends 'FecdasPartesBundle::layout.html.twig' %}

{% block javascriptshead %}
 	{{ parent() }}
   	 {{ form_javascript(form) }}
{% endblock %}

{% block title %}Aplicació gestió FECDAS. Relació d'assegurats del Club{% endblock %}

{% block body %}
	<header>
        <h1>Relació d'assegurats vigents</h1>
    </header>

   	<form action="{{ path('FecdasPartesBundle_assegurats') }}" method="post" {{ form_enctype(form) }}  class="appform">
   		<div class="form-row clearfix">
			<div id="formassegurats-clubs" class="form-left">
				{{ form_widget(form.clubs, { 'attr': {'class': 'formfield-outside'} }) }}
			</div>
			<div id="formassegurats-vigent" class="form-left">
				{{ form_label(form.vigent, 'Només mostrar llista amb llicència vigent', { 'attr': {'class': 'formlabel-lefttocheckbox'} }) }}
				{{ form_widget(form.vigent, { 'attr': {'class': 'formcheckbox-right'} }) }}
			</div>
			<div class="button-top"><a href="{{ path('FecdasPartesBundle_asseguratstopdf', { 'club': club }) }}">
				<img src="{{ asset('images/icon-pdf.png') }}" alt="Descarregar les llistes" 
				title="Descarregar les llistes" width="25px"></a></div> 
		</div>
   		<div class="form-row clearfix">
			<div id="formassegurats-dni" class="form-left">
				{{ form_label(form.dni, 'DNI/NIE', { 'attr': {'class': 'formlabel-inside'} }) }}
				{{ form_widget(form.dni, { 'attr': {'class': 'forminput-inside'} }) }}
			</div> 
   			<div id="formassegurats-nom" class="form-left">
				{{ form_label(form.nom, 'Nom', { 'attr': {'class': 'formlabel-inside'} }) }}
				{{ form_widget(form.nom, { 'attr': {'class': 'forminput-inside'} }) }}
			</div> 
        	<div id="formassegurats-cognoms" class="form-left">
				{{ form_label(form.cognoms, 'Cognoms', { 'attr': {'class': 'formlabel-inside'} }) }}
				{{ form_widget(form.cognoms, { 'attr': {'class': 'forminput-inside'} }) }}
			</div> 
			<div id="formassegurats-submit" class="form-right">	
				<input type="submit" class="forminput-inside" value="Cerca" name="formassegurats-button-search"/>
			</div> 
   		</div>
    </form>

    {% if app.session.hasFlash('error-notice') %}
    <div class="sms-notice">
        {{ app.session.flash('error-notice') }}
    </div>
	{% endif %}
	<div id="llista-assegurats">
		<div class="table-header">	
		   	<div id="list-header">
		   		<div id="header-asseguratid" class="col-listheader">id</div>
		   		<div id="header-asseguratdni" class="col-listheader">DNI<span class="listheader-order"></span></div>
		   		<div id="header-asseguratnom" class="col-listheader">Nom<span class="listheader-order"></span></div>
		   		<div id="header-asseguratcognoms" class="col-listheader">Cognoms<span class="listheader-order"></span></div>
		   		<div id="header-assegurattipusdesc" class="col-listheader listheader-noorder">Vigència de la llicència</div>
		   		<div id="header-asseguratactions" class="col-listheader listheader-noorder">&nbsp;</div>
		   	</div>
	   	</div>
		{% if persones|length > 0 %}
		<div class="table-scroll">
		   	<ol id="list-data">
			{% for persona in persones %}
				{% if vigents != true or (vigents == true and persona.llicenciaVigent is not null)  %}
			   		<li class="data-detall">
				   		<div class="data-detall-cell assegurat-id">{{ persona.id }}</div>
				   		<div class="data-detall-cell assegurat-dni">{{ persona.dni }}</div>
				   		<div class="data-detall-cell assegurat-nom">{{ persona.nom }}</div>
				   		<div class="data-detall-cell assegurat-cognoms">{{ persona.cognoms }}</div>
				   		{% if persona.llicenciaVigent is not null and persona.llicenciaVigent.parte is not null %}
							<div class="data-detall-cell assegurat-tipusdesc">{{ persona.llicenciaVigent.categoria.descripcio }} fins al {{ persona.llicenciaVigent.parte.datacaducitat|date('d/m/Y') }}</div>
							<div class="data-detall-cell assegurat-actions">
							{% if persona.llicenciaVigent.parte.allowPrintLlicencia == true %}
							<a class="action-cell llicencia-imprimir" href="{{ path('FecdasPartesBundle_licensetopdf', { 'id': persona.llicenciaVigent.id}) }}">
								<img src="{{ asset('images/icon-license.png') }}" alt="Imprimir llicència" title="Imprimir llicència" width="23px"></a>
							{% else %}
							<div class="action-cell"></div>
							{% endif %}
							<a class="action-cell llicencia-renovar" href="{{ path('FecdasPartesBundle_renovarllicencia', { 'id': persona.llicenciaVigent.id }) }}">
			   					<img src="{{ asset('images/icon-renovar.png') }}" alt="Renovar llicència" title="Renovar llicència" width="23px"></a>
			   				<a class="action-cell parte-action-view" href="{{ path('FecdasPartesBundle_parte', { 'id': persona.llicenciaVigent.parte.id, 'action':'view' }) }}">
			   					<img src="{{ asset('images/icon-view.png') }}" alt="Veure llicència" title="Veure llicència" width="23px"></a>
							<a class="action-cell assegurats-openmodal" href="{{ path('FecdasPartesBundle_persona') }}" name="modal">
			   					<img src="{{ asset('images/icon-edit-user.png') }}" alt="Editar dades federat" title="Editar dades federat" width="23px"></a>
			   				</div>
			   			{% else %}
			   				{% if persona.lastLlicencia is not null and persona.lastLlicencia.parte is not null %}
				   				<div class="data-detall-cell assegurat-novigent">Darrera llicència finalitzada en data {{ persona.lastLlicencia.parte.datacaducitat|date('d/m/Y') }}</div>
				   				
				   				<div class="data-detall-cell assegurat-actions">
			   					<a class="llicencia-renovar" href="{{ path('FecdasPartesBundle_renovarllicencia', { 'id': persona.lastLlicencia.id }) }}">
			   						<img src="{{ asset('images/icon-renovar.png') }}" alt="Renovar llicència" title="Renovar llicència" width="23px"></a>
			   					<a class="parte-action-view" href="{{ path('FecdasPartesBundle_parte', { 'id': persona.lastLlicencia.parte.id, 'action':'view' }) }}">
			   						<img src="{{ asset('images/icon-view.png') }}" alt="Veure llicència" title="Veure llicència" width="23px"></a>
				   				<a class="assegurats-openmodal" href="{{ path('FecdasPartesBundle_persona') }}" name="modal">
			   						<img src="{{ asset('images/icon-edit-user.png') }}" alt="Editar dades federat" title="Editar dades federat" width="23px"></a>
			   					</div>
			   				{% else %}
			   					<div class="data-detall-cell assegurat-novigent">Persona sense historial de llicències</div>
			   					
			   					<div class="data-detall-cell assegurat-actions"><a class="assegurats-openmodal" href="{{ path('FecdasPartesBundle_persona') }}" name="modal">
			   						<img src="{{ asset('images/icon-edit-user.png') }}" alt="Editar dades federat" title="Editar dades federat" width="23px"></a></div>
			   				{% endif %}	
				   		{% endif %}		
			   		</li>
		   		{% endif %}	
			{% endfor %}
			</ol>
		</div>
	   	{% else %}
	   		
	        <div class="sms-notice">No hi ha assegurats vigents per aquest club</div>
	    {% endif %}
	</div>
    
    <div id="edicio-persona" class="finestra-overlay"></div>
    
{% endblock %}

{% block javascripts %}

{{ parent() }}

<script type="text/javascript">

$(document).ready(function(){
	setMenuActive("menu-assegurats");
	
	helpBubbles("#form_dni", '<p>Indica tot o part del <b>DNI/NIE</b> a cercar</p>');
	
	helpBubbles("#form_nom", '<p>Indica tot o part del <b>NOM</b> a cercar</p>\
	<p>La cerca no distingeix majúscules o minúscules</p>');

	helpBubbles("#form_cognoms", '<p>Indica tot o part dels <b>COGNOMS</b> a cercar</p>\
	<p>La cerca no distingeix majúscules o minúscules</p>');

	showPersonClickAssegurats();

	sortLlista("col-listheader", "list-data");

	var tableScroll = $('.table-scroll');
	if (tableScroll.hasOverflowY()) {
		$('.table-scroll').css({"width":"101.5%"});
	}
});

</script>


{% endblock %}
