{# src/Fecdas/PartesBundle/Resources/views/Titulacions/dadesfederat.html.twig #}
{% extends 'FecdasBundle::layout.html.twig' %}

{% block title %}Aplicació gestió FECDAS. Dades personals{% endblock %}

{% block body %}
   	<header>
		<div class="row">
			<div class="col-md-8"><h1>Dades personals</h1></div>
			<div class="col-md-3 col-last-right">
				<div class="buttons-top-bootstrap">
					<div class="button-top">
						<a class="link save-data" href="{{ path('FecdasBundle_dadesfederat') }}" alt="Desar els canvis" 
						title="Desar els canvis"><i class="fa fa-save fa-1x green"></i></a>
					</div>	
				</div> 
			</div>
		</div>
	</header>
   	
  	<div id="dades-federat" class="row">
  		<div class="col-md-11 block-errors">{% include 'FecdasBundle:Includes:messages.html.twig' %}</div>
  		<div class="col-md-11">
   	    {% include 'FecdasBundle:Titulacions:dadesfederatpersona.html.twig' %}
   	    </div>
	</div>
	<div class="row space50"></div>
    
{% endblock %}

{% block javascripts %}

	{{ parent() }}

	<script src="{{ asset('js/utils/purl.js') }}" type="text/javascript"></script>
	
	<script type="text/javascript">

	$(document).ready(function(){
		setMenuActive("menu-fededades");

		var current = new Date();
		var mindate = new Date( current.getFullYear() - 100, 1 - 1, 1);
		var maxdate = new Date ( current.getFullYear() - 4, 1 - 1, 1);
		var opendate = new Date ( current.getFullYear() - 30, 1 - 1, 1);
		initDateTimePicker ( 
			$( '#persona_datanaixement' ), 
			mindate, 
			maxdate, 
			opendate, 
			'datanaixement-picker', 
			false
		);

		formFocus();
		
		autocompleters( $('#formpersona-autocompleters').attr('href'), $('#persona_addrpob'), $('#persona_addrcp'), $('#persona_addrprovincia'), $('#persona_addrcomarca'), "#edicio-persona" );
		
		imageUploadForm("#persona_fotoupld", 104);
		
		/*prepareRemoveFotoGaleria( "#dades-federat", function() {
			// Accions addicionals
			$('#persona_foto').val( '' );
		});*/

		$( "#dades-federat" ).on( "click", ".remove-foto", function( e ) {
			//Cancel the link behavior
	        e.preventDefault();

	        var url = $(this).attr('href');
			var galeria = $(this).parent('.galeria-remove-foto'); 

			if ($('#persona_foto').val() == '') {
				// Not saved
		        galeria.prev('input[type="file"]').val('');
	        
		        galeria.prev('.galeria-upload').html('<div class="image-upload"><span class="box-center-txt">Pujar foto<br/>(click)</span></div>');
	        
		        galeria.remove();

		        return false;
			}
			
			var strHtml = '<p>Segur que vols treure la foto?</p>';
			dialegConfirmacio(strHtml, 'Esborrar arxiu', 'auto', 400, function() {

				$('.alert').remove();
				 
				$.get(url, function(data) {
					// Remove
			        galeria.prev('input[type="file"]').val('');
		        
			        galeria.prev('.galeria-upload').html('<div class="image-upload"><span class="box-center-txt">Pujar foto<br/>(click)</span></div>');
		        
			        galeria.remove();

					$('#persona_foto').val( '' );
					
				}).fail( function(xhr, status, error) {
	        		// xhr.status + " " + xhr.statusText, status, error
		        	var sms = smsResultAjax('KO', xhr.responseText);
		    			 
		   			$('.block-errors').append(sms);
	        	});
				closeDialegConfirmacio();

				
			}, function() { closeDialegConfirmacio(); }, function() { });

			
		});
		
		//prepareRemoveFile( , '' );

		$( "#dades-federat" ).on( "click", ".remove-file", function( e ) {
	        //Cancel the link behavior
	        e.preventDefault();

	        var url = $(this).attr('href');
			var parentRow = $(this).parents('div.item-historial'); 

			var strHtml = '<p>Segur que vols esborrar aquest arxiu?</p>';
			dialegConfirmacio(strHtml, 'Esborrar arxiu', 'auto', 400, function() {

				$('.alert').remove();
				 
				$.get(url, function(data) {
					// Remove
					parentRow.remove();
					
				}).fail( function(xhr, status, error) {
	        		// xhr.status + " " + xhr.statusText, status, error
		        	var sms = smsResultAjax('KO', xhr.responseText);
		    			 
		   			$('.block-errors').append(sms);
	        	});
				closeDialegConfirmacio();
				 
			}, function() { closeDialegConfirmacio(); }, function() { });
		});
		
		
		prepareFileInput( $("#persona_arxiuupld") );
		
		$("select#persona_addrprovincia").select2({
			minimumInputLength: 2,
			allowClear: true,
			placeholder: "Província",
		});
		$("select#persona_addrcomarca").select2({
			minimumInputLength: 2,
			allowClear: true,
			placeholder: "Comarca",
		});
		$("select#persona_addrnacionalitat").select2({
			minimumInputLength: 1,
			allowClear: true,
			placeholder: "ESP",
		});

		$('.save-data').click(function (e) {
	        //Cancel the link behavior
	        e.preventDefault();
	        var i = '';
	        $("#dialeg").dialog({
	          	buttons : {
	            	"Confirmar" : {
	            		click: function() {
		    	        	$(this).dialog("close");
		    	        	if ($('#persona_mail').val() != "") {  // Múltiples adreces acceptades mail 1; mail 2; ...
		    	        		var mails = $('#persona_mail').val().split(";");
	
		    	        		for (i in mails) {
		    	        			if (mails[i].trim() != "" && !isValidEmailAddress( mails[i].trim() ) ) {
							        	dialegError("Error", "L'adreça de correu -"+mails[i]+"- no té un format correcte", 400);
										return false;
					   	        	}
								}
		    	        	}	
		    	        	$('#formpersona').submit();
		    	        	

	            		},
	            		text: "Confirmar",
	            		class: "btn btn-default"
	        		},
	            	"Cancel·lar" : {
	            		click: function() {
	            			$(this).dialog("close");
	            		},
	            		text: "Cancel·lar",
	            		class: "btn btn-default"
	            	}
	          	},
	        	title: "Actualitzar dades",
	        	height: "auto",
	        	width: 400,
	        	zIndex:	350
	        });
			
			var htmlRecordatori = "";
			
			if ($('#persona_mail').val() == "") {
				htmlRecordatori += "<p>Cal indicar alguna <strong>l'adreça de correu</strong></p>";	
			}
			if (htmlRecordatori == "") {
				htmlRecordatori = "<p>Confirmeu per desar els canvis o cancel·leu per descartar-los</p>";
			}
	        $("#dialeg").html(htmlRecordatori);
	        $("#dialeg").dialog("open");
	        
	    }); 
		
	});
	
	</script>


{% endblock %}
